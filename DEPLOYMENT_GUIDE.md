# Руководство по развертыванию Telegram-бота для проверки ОСАГО и штрафов

Это руководство поможет вам развернуть Telegram-бота, написанного на Python, на бесплатной хостинг-платформе с использованием GitHub для хранения кода. Бот предназначен для проверки информации по ОСАГО и штрафам через предоставленные API.

## 1. Предварительные требования

Перед началом убедитесь, что у вас есть:

1.  **Аккаунт GitHub**: Для хранения кода и интеграции с хостинг-платформой.
2.  **Токен Telegram-бота**: Получите его от BotFather в Telegram. Сохраните этот токен, он понадобится позже. **Никогда не делитесь им публично.**
3.  **API ключ для сервиса ОСАГО/Штрафов**: Вы предоставили ключ `21c10cf514148b7536efa51b43d04955`. Этот ключ также является секретным.
4.  **Установленный Git**: Для работы с репозиториями GitHub.
5.  **Python 3.7+**: Для локального тестирования (рекомендуется).

## 2. Структура проекта

Вам будут предоставлены следующие файлы и папки:

```
telegram_bot/
├── src/
│   ├── bot.py           # Основная логика бота
│   ├── api_client.py    # Функции для взаимодействия с API ОСАГО/Штрафов
│   └── config.py        # Загрузка конфигурации (API ключей из переменных окружения)
├── requirements.txt     # Список зависимостей Python
├── .gitignore           # Файл для исключения ненужных файлов из Git
└── DEPLOYMENT_GUIDE.md  # Это руководство
```

## 3. Локальная настройка и тестирование (Рекомендуется)

Перед развертыванием на хостинге, рекомендуется протестировать бота локально.

1.  **Создайте папку для проекта** на вашем компьютере и перейдите в нее.
2.  **Скопируйте все предоставленные файлы** (`src` папку, `requirements.txt`, `.gitignore`) в эту папку.
3.  **Создайте и активируйте виртуальное окружение** (рекомендуется):
    ```bash
    python -m venv venv
    # Windows
    venv\Scripts\activate
    # macOS/Linux
    source venv/bin/activate
    ```
4.  **Установите зависимости**:
    ```bash
    pip install -r requirements.txt
    ```
5.  **Настройте переменные окружения**. Создайте файл `.env` в корневой папке проекта (на одном уровне с `src` и `requirements.txt`). **Этот файл не должен попасть в GitHub**, так как `.gitignore` уже настроен для его игнорирования.
    Содержимое файла `.env`:
    ```
    TELEGRAM_BOT_TOKEN="ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН"
    OSAGO_API_KEY="21c10cf514148b7536efa51b43d04955"
    FINES_API_KEY="21c10cf514148b7536efa51b43d04955"
    ```
    Замените `ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН` на ваш реальный токен.
    *Примечание: Для загрузки переменных из `.env` файла при локальном запуске, вы можете добавить библиотеку `python-dotenv` в `requirements.txt` и немного модифицировать `config.py` для её использования, либо устанавливать переменные окружения вручную в вашей системе перед запуском.*

    Для простоты, текущий `config.py` ожидает, что переменные окружения уже установлены в системе. Если вы хотите использовать `.env` с `python-dotenv`:
    *   Добавьте `python-dotenv` в `requirements.txt`.
    *   Измените `src/config.py`:
        ```python
        import os
        from dotenv import load_dotenv

        load_dotenv() # Загружает переменные из .env файла

        TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
        # ... остальной код config.py ...
        ```
6.  **Запустите бота локально**:
    ```bash
    python -m src.bot 
    ```
    Или, если вы находитесь в папке `telegram_bot`:
    ```bash
    python src/bot.py
    ```
    Проверьте его работу, отправляя команды в Telegram.

## 4. Настройка репозитория GitHub

1.  **Создайте новый репозиторий на GitHub**. Вы можете сделать его публичным, так как API ключи не будут храниться в коде.
2.  **Инициализируйте Git в локальной папке проекта** (если еще не сделали) и добавьте удаленный репозиторий:
    ```bash
    git init
    git add .
    git commit -m "Initial commit of Telegram bot"
    git branch -M main
    git remote add origin https://github.com/ВАШ_ПОЛЬЗОВАТЕЛЬ/ВАШ_РЕПОЗИТОРИЙ.git
    git push -u origin main
    ```
    Замените `ВАШ_ПОЛЬЗОВАТЕЛЬ/ВАШ_РЕПОЗИТОРИЙ` на ваши данные.

3.  **Настройте GitHub Secrets для хранения API ключей**:
    *   В вашем репозитории GitHub перейдите в `Settings` -> `Secrets and variables` -> `Actions`.
    *   Нажмите `New repository secret`.
    *   Создайте следующие секреты:
        *   `TELEGRAM_BOT_TOKEN`: Вставьте ваш токен Telegram-бота.
        *   `OSAGO_API_KEY`: Вставьте ваш API ключ `21c10cf514148b7536efa51b43d04955`.
        *   `FINES_API_KEY`: Вставьте ваш API ключ `21c10cf514148b7536efa51b43d04955`.

    Эти секреты будут использоваться хостинг-платформой для безопасного доступа к вашим ключам.

## 5. Выбор и развертывание на бесплатной хостинг-платформе

Существует несколько платформ, предлагающих бесплатные тарифы для хостинга Python-приложений. Мы рассмотрим **Render.com** как основной вариант и **PythonAnywhere** как альтернативу.

### Вариант 1: Развертывание на Render.com

Render.com хорошо интегрируется с GitHub и позволяет легко настраивать переменные окружения.

1.  **Зарегистрируйтесь или войдите** на [Render.com](https://render.com/).
2.  На панели управления нажмите `New +` -> `Background Worker` (бот не является веб-сервисом, ему не нужен открытый HTTP порт, он работает в фоне, опрашивая Telegram).
3.  **Подключите ваш GitHub репозиторий**. Выберите репозиторий, который вы создали.
4.  **Настройте сервис**:
    *   **Name**: Дайте имя вашему боту (например, `osago-fines-telegram-bot`).
    *   **Region**: Выберите подходящий регион.
    *   **Branch**: `main` (или ваша основная ветка).
    *   **Root Directory**: Оставьте пустым, если `requirements.txt` находится в корне репозитория. Если ваш код в подпапке (например, `telegram_bot`), укажите ее.
    *   **Runtime**: `Python 3` (Render обычно определяет это автоматически).
    *   **Build Command**: `pip install -r requirements.txt` (обычно Render предлагает это по умолчанию).
    *   **Start Command**: `python src/bot.py`.
    *   **Instance Type**: `Free`.
5.  **Добавьте переменные окружения**:
    *   Перейдите в раздел `Environment` вашего нового сервиса на Render.
    *   Нажмите `Add Environment Variable` или `Add Secret File` (для переменных окружения лучше `Add Environment Variable`).
    *   Добавьте следующие переменные, используя значения, которые вы сохранили (или значения из GitHub Secrets, если вы их там храните как источник правды):
        *   `TELEGRAM_BOT_TOKEN`: `ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН`
        *   `OSAGO_API_KEY`: `21c10cf514148b7536efa51b43d04955`
        *   `FINES_API_KEY`: `21c10cf514148b7536efa51b43d04955`
        *   `PYTHON_VERSION`: Укажите версию Python, которую вы используете (например, `3.9.10` или ту, что поддерживает Render и совместима с вашим кодом). Это может помочь избежать проблем совместимости.
6.  **Нажмите `Create Background Worker`**.
    Render начнет сборку и развертывание вашего бота. Вы можете следить за процессом в разделе `Events` или `Logs`.
7.  **Проверка логов**: После завершения развертывания проверьте логи на наличие ошибок. Если все в порядке, ваш бот должен быть запущен и отвечать в Telegram.

### Вариант 2: Развертывание на PythonAnywhere

PythonAnywhere предлагает простой способ запуска Python-скриптов.

1.  **Зарегистрируйтесь или войдите** на [PythonAnywhere.com](https://www.pythonanywhere.com/). Бесплатный аккаунт имеет некоторые ограничения (например, доступ только к определенным сайтам из белого списка, если боту нужен внешний доступ, который не разрешен, это может быть проблемой, но для Telegram API это обычно работает).
2.  **Загрузите код**:
    *   Перейдите на вкладку `Files` и загрузите файлы вашего проекта (папку `src`, `requirements.txt`).
    *   Или, откройте `Bash console` на вкладке `Consoles` и клонируйте ваш репозиторий с GitHub:
        ```bash
        git clone https://github.com/ВАШ_ПОЛЬЗОВАТЕЛЬ/ВАШ_РЕПОЗИТОРИЙ.git
        ```
        Затем перейдите в папку с проектом: `cd ВАШ_РЕПОЗИТОРИЙ`.
3.  **Настройте виртуальное окружение и установите зависимости** (в Bash консоли PythonAnywhere):
    ```bash
    python -m venv venv_telegram_bot --python=python3.9 # Укажите нужную версию Python
    source venv_telegram_bot/bin/activate
    pip install -r requirements.txt
    ```
4.  **Установите переменные окружения**: PythonAnywhere не имеет прямого UI для установки переменных окружения для Always-on tasks так же, как Render. Есть несколько способов:
    *   **Через файл `.env` и `python-dotenv`**: Если вы настроили `python-dotenv` как описано в разделе локальной настройки, создайте файл `.env` в корневой директории вашего проекта на PythonAnywhere (через вкладку `Files` или в Bash консоли) с вашими ключами.
    *   **Через скрипт-обертку**: Создайте небольшой скрипт `run_bot.sh`, который устанавливает переменные и затем запускает бота:
        ```bash
        #!/bin/bash
        export TELEGRAM_BOT_TOKEN="ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН"
        export OSAGO_API_KEY="21c10cf514148b7536efa51b43d04955"
        export FINES_API_KEY="21c10cf514148b7536efa51b43d04955"
        # Убедитесь, что вы находитесь в правильной директории и активировали venv
        cd /home/ВАШ_ЛОГИН_PYTHONANYWHERE/ВАШ_РЕПОЗИТОРИЙ/
        source venv_telegram_bot/bin/activate
        python src/bot.py
        ```
        Сделайте его исполняемым: `chmod +x run_bot.sh`.
5.  **Настройте Always-on Task**:
    *   Перейдите на вкладку `Tasks`.
    *   В разделе `Always-on tasks` нажмите `Add new Always-on task`.
    *   В качестве команды укажите путь к вашему основному скрипту бота, используя полный путь и Python из вашего виртуального окружения. Например:
        `/home/ВАШ_ЛОГИН_PYTHONANYWHERE/ВАШ_РЕПОЗИТОРИЙ/venv_telegram_bot/bin/python /home/ВАШ_ЛОГИН_PYTHONANYWHERE/ВАШ_РЕПОЗИТОРИЙ/src/bot.py`
        Или, если вы используете скрипт-обертку:
        `/home/ВАШ_ЛОГИН_PYTHONANYWHERE/ВАШ_РЕПОЗИТОРИЙ/run_bot.sh`
6.  **Проверьте логи**: Логи для Always-on task доступны на той же вкладке `Tasks`. Если есть ошибки, они будут отображены там.

## 6. Важные замечания по безопасности и работе

*   **Никогда не встраивайте API ключи напрямую в код**, который вы публикуете на GitHub или где-либо еще.
*   **Используйте переменные окружения** на хостинг-платформе для хранения секретных ключей.
*   **Файл `.gitignore`** помогает предотвратить случайную загрузку секретов (например, файла `.env`) в репозиторий.
*   **Лимиты API**: Помните, что предоставленные API для ОСАГО и штрафов имеют лимит в 200 запросов в месяц. Бот имеет базовую обработку ошибок, но не отслеживает количество запросов. При превышении лимита API начнут возвращать ошибки.
*   **Бесплатные тарифы хостинга**: Бесплатные тарифы могут иметь ограничения (например, засыпание приложения при неактивности, ограниченные ресурсы). Для Telegram-бота, который должен быть постоянно активен, выбирайте платформы, которые поддерживают это на бесплатных тарифах (Render Background Workers или PythonAnywhere Always-on tasks обычно подходят).

## 7. Обновление бота

1.  Внесите изменения в локальный код.
2.  Закоммитьте и отправьте изменения на GitHub:
    ```bash
    git add .
    git commit -m "Описание ваших изменений"
    git push origin main
    ```
3.  **Render.com**: Если настроена автоматическая сборка из ветки (по умолчанию), Render автоматически пересобирает и перезапустит вашего бота.
4.  **PythonAnywhere**: Вам нужно будет вручную обновить код на сервере (например, `git pull` в Bash консоли) и перезапустить Always-on task на вкладке `Tasks`.

Поздравляем! Теперь у вас есть работающий Telegram-бот, развернутый безопасно и бесплатно.

